#!/bin/bash
#
# LocalMind Deployment Script
#
# This is a convenience wrapper around `kamal deploy`.
# The actual deployment logic is in .kamal/hooks/pre-deploy
#
# Usage:
#   ./bin/deploy           # Default: builds with --no-cache (reliable)
#   ./bin/deploy --cached  # Uses Docker cache (faster, for frontend-only changes)
#

set -e

cd "$(dirname "$0")/.."

# Parse arguments
USE_CACHE=false
for arg in "$@"; do
    case $arg in
        --cached)
            USE_CACHE=true
            shift
            ;;
    esac
done

# Export for pre-deploy hook to use
export DEPLOY_USE_CACHE="$USE_CACHE"

echo "╔════════════════════════════════════════╗"
echo "║     LocalMind Deployment               ║"
echo "╚════════════════════════════════════════╝"
echo ""

if [ "$USE_CACHE" = true ]; then
    echo "Mode: CACHED (faster, uses Docker cache)"
    echo "      Use this for frontend-only changes"
else
    echo "Mode: FRESH (--no-cache, reliable)"
    echo "      Use --cached flag for faster builds"
fi

echo ""
echo "Running kamal deploy..."
echo "This will:"
echo "  1. Build and push backend image (pre-deploy hook)"
echo "  2. Deploy backend container"
echo "  3. Build and push frontend image"
echo "  4. Deploy frontend container"
echo ""

kamal deploy

echo ""
echo "✓ Deployment complete!"
echo "  Frontend: http://192.168.1.173"
echo "  Backend:  http://192.168.1.173:8001"
