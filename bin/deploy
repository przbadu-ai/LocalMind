#!/bin/bash
#
# LocalMind Deployment Script
#
# This is a convenience wrapper around `kamal deploy`.
# The actual deployment logic is in .kamal/hooks/pre-deploy
#
# Usage:
#   ./bin/deploy           # Default: uses Docker cache (fast)
#   ./bin/deploy --no-cache  # Fresh build without cache (slow, use when deps change)
#

set -e

cd "$(dirname "$0")/.."

# Parse arguments
NO_CACHE=false
for arg in "$@"; do
  case $arg in
  --no-cache)
    NO_CACHE=true
    shift
    ;;
  esac
done

# Export for pre-deploy hook to use
export DEPLOY_NO_CACHE="$NO_CACHE"

echo "╔════════════════════════════════════════╗"
echo "║     LocalMind Deployment               ║"
echo "╚════════════════════════════════════════╝"
echo ""

if [ "$NO_CACHE" = true ]; then
  echo "Mode: FRESH (--no-cache, rebuilds everything)"
  echo "      This is slow. Only use when dependencies change."
else
  echo "Mode: CACHED (fast, uses Docker layer cache)"
  echo "      Use --no-cache if you changed requirements.txt"
fi

echo ""
echo "Running kamal deploy..."
echo "This will:"
echo "  1. Build and push backend image (pre-deploy hook)"
echo "  2. Deploy backend container"
echo "  3. Build and push frontend image"
echo "  4. Deploy frontend container"
echo ""

kamal deploy

# Get server IP from .env file
if [ -f ".env" ]; then
  DEPLOY_SERVER_IP=$(grep -E "^DEPLOY_SERVER_IP=" ".env" | cut -d'=' -f2)
fi

if [ -z "$DEPLOY_SERVER_IP" ]; then
  echo ""
  echo "✓ Deployment complete!"
  echo "  Check your server at the IP configured in .env"
else
  echo ""
  echo "✓ Deployment complete!"
  echo "  Frontend: http://$DEPLOY_SERVER_IP"
  echo "  Backend:  http://$DEPLOY_SERVER_IP:8001"
fi
