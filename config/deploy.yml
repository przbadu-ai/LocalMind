# Kamal deployment configuration for LocalMind
# Documentation: https://kamal-deploy.org/docs/configuration/
#
# Deployment: Just run `kamal deploy` - it handles both frontend and backend!
#
# The pre-deploy hook (.kamal/hooks/pre-deploy) automatically:
#   1. Builds the backend Docker image
#   2. Pushes it to the registry
#   3. Deploys and restarts the backend container
#   4. Waits for health check
#   5. Then Kamal deploys the frontend
#
# Quick Start:
#   1. Copy .env.example to .env and configure your values
#   2. Copy .kamal/secrets.example to .kamal/secrets
#   3. Run: kamal setup (first time) or kamal deploy (updates)

service: localmind

# Docker image name - pushed to registry
# Note: registry server (ghcr.io) is added automatically from registry.server
image: przbadu/localmind

# Deployment servers
servers:
  web:
    hosts:
      - <%= ENV['DEPLOY_SERVER_IP'] || raise('DEPLOY_SERVER_IP environment variable is required') %>
    options:
      add-host: host.docker.internal:host-gateway

# Kamal proxy configuration
# Hosts are loaded from .kamal/secrets: DEPLOY_SERVER_IP and DEPLOY_DOMAIN
proxy:
  ssl: false
  hosts:
    - <%= ENV['DEPLOY_SERVER_IP'] || raise('DEPLOY_SERVER_IP environment variable is required') %>
<% if ENV['DEPLOY_DOMAIN'] && !ENV['DEPLOY_DOMAIN'].empty? %>
    - <%= ENV['DEPLOY_DOMAIN'] %>
<% end %>
  app_port: 80
  healthcheck:
    path: /
    interval: 10

# SSH configuration
ssh:
  user: root

# Container registry
registry:
  server: ghcr.io
  username: przbadu
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables for the main app (frontend)
env:
  clear:
    # Backend URL for nginx proxy (Docker network name)
    BACKEND_HOST: localmind-backend
    BACKEND_PORT: "8001"

# Persistent volumes
volumes:
  - /var/data/localmind:/app/data

# Note: Backend is deployed via pre-deploy hook (.kamal/hooks/pre-deploy)
# This ensures the backend image is always built and deployed with the frontend

# Build configuration
builder:
  arch: amd64
  # Uncomment for multi-arch builds:
  # multiarch: true
  args:
    APP_VERSION: <%= `cat VERSION 2>/dev/null || echo "0.0.0-dev"`.strip %>
    GIT_COMMIT: <%= `git rev-parse --short HEAD 2>/dev/null || echo "unknown"`.strip %>
    VITE_CLERK_PUBLISHABLE_KEY: <%= ENV['VITE_CLERK_PUBLISHABLE_KEY'] || '' %>
    AUTH_ENABLED: <%= ENV['AUTH_ENABLED'] || 'false' %>
    AUTH_ALLOW_SIGNUP: <%= ENV['AUTH_ALLOW_SIGNUP'] || 'false' %>

# Logging configuration

# Number of old containers to keep for rollback
retain_containers: 3
