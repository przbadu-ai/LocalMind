#!/bin/bash
#
# Kamal pre-deploy hook
# This runs before the main app deployment
# It builds and pushes the backend image, then restarts the backend accessory
#
# Build modes:
#   Default: uses Docker cache (fast, recommended)
#   With DEPLOY_NO_CACHE=true: --no-cache for fresh build (slow, use when dependencies change)
#

set -e

echo "==> Pre-deploy: Building and deploying backend..."

BACKEND_IMAGE="ghcr.io/przbadu/localmind-backend:latest"
PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

# Get version from VERSION file
APP_VERSION=$(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo "0.0.0-dev")
GIT_COMMIT=$(git -C "$PROJECT_ROOT" rev-parse --short HEAD 2>/dev/null || echo "unknown")

echo "==> Version: $APP_VERSION (commit: $GIT_COMMIT)"

# Determine cache mode (default to using cache for faster builds)
if [ "$DEPLOY_NO_CACHE" = "true" ]; then
    echo "==> Building backend Docker image (--no-cache for fresh build)..."
    CACHE_FLAG="--no-cache"
else
    echo "==> Building backend Docker image (with cache for faster builds)..."
    CACHE_FLAG=""
fi

# Build backend image with version info
docker build \
  $CACHE_FLAG \
  --build-arg APP_VERSION="$APP_VERSION" \
  --build-arg GIT_COMMIT="$GIT_COMMIT" \
  -t "$BACKEND_IMAGE" \
  "$PROJECT_ROOT/backend"

# Push backend image
echo "==> Pushing backend image to registry..."
docker push "$BACKEND_IMAGE"

# Get server IP from environment or .env file
if [ -z "$DEPLOY_SERVER_IP" ]; then
  if [ -f "$PROJECT_ROOT/.env" ]; then
    DEPLOY_SERVER_IP=$(grep -E "^DEPLOY_SERVER_IP=" "$PROJECT_ROOT/.env" | cut -d'=' -f2)
  fi
fi
if [ -z "$DEPLOY_SERVER_IP" ]; then
  echo "ERROR: DEPLOY_SERVER_IP is not set. Please set it in your .env file or environment."
  exit 1
fi

# Pull new image on server and restart container
echo "==> Deploying backend to server $DEPLOY_SERVER_IP..."
ssh root@$DEPLOY_SERVER_IP "
  docker pull $BACKEND_IMAGE

  # Stop and remove existing container if it exists
  docker stop localmind-backend 2>/dev/null || true
  docker rm localmind-backend 2>/dev/null || true

  # Create kamal network if it doesn't exist (first-time setup)
  docker network create kamal 2>/dev/null || true

  # Start new container on Kamal's network so frontend can reach it by hostname
  # Mount Docker socket for Docker-based MCP servers
  docker run -d \
    --name localmind-backend \
    --network kamal \
    --restart unless-stopped \
    --add-host host.docker.internal:host-gateway \
    -p 8001:8001 \
    -v /var/data/localmind:/app/data \
    -v /var/run/docker.sock:/var/run/docker.sock \
    -e PYTHONPATH=/app \
    -e DATABASE_PATH=/app/data/local_mind.db \
    -e 'OLLAMA_HOST=http://host.docker.internal:11434' \
    $BACKEND_IMAGE \
    uvicorn main:app --host 0.0.0.0 --port 8001
"

# Wait for backend to be healthy
echo "==> Waiting for backend health check..."
for i in {1..12}; do
    if ssh root@$DEPLOY_SERVER_IP "curl -sf http://localhost:8001/health" > /dev/null 2>&1; then
        echo "==> Backend is healthy!"
        exit 0
    fi
    echo "  Waiting for backend... (attempt $i/12)"
    sleep 5
done

echo "==> Warning: Backend health check timed out, continuing with frontend deploy..."
