#!/bin/bash
#
# Kamal pre-build hook
# This runs before the Docker image build
# It sets version info as build arguments for the Docker build
#

set -e

echo "==> Pre-build: Setting version info for Docker build..."

PROJECT_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

# Get version from VERSION file
APP_VERSION=$(cat "$PROJECT_ROOT/VERSION" 2>/dev/null || echo "0.0.0-dev")
GIT_COMMIT=$(git -C "$PROJECT_ROOT" rev-parse --short HEAD 2>/dev/null || echo "unknown")

echo "    APP_VERSION=$APP_VERSION"
echo "    GIT_COMMIT=$GIT_COMMIT"

# Build args string
BUILD_ARGS="APP_VERSION=$APP_VERSION GIT_COMMIT=$GIT_COMMIT"

# Add authentication build args if configured
if [ -n "$VITE_CLERK_PUBLISHABLE_KEY" ]; then
    echo "    AUTH_ENABLED=true"
    BUILD_ARGS="$BUILD_ARGS VITE_CLERK_PUBLISHABLE_KEY=$VITE_CLERK_PUBLISHABLE_KEY AUTH_ENABLED=true"

    # Check if signup should be allowed (defaults to false)
    if [ "$AUTH_ALLOW_SIGNUP" = "true" ]; then
        echo "    AUTH_ALLOW_SIGNUP=true"
        BUILD_ARGS="$BUILD_ARGS AUTH_ALLOW_SIGNUP=true"
    else
        echo "    AUTH_ALLOW_SIGNUP=false"
        BUILD_ARGS="$BUILD_ARGS AUTH_ALLOW_SIGNUP=false"
    fi
else
    echo "    AUTH_ENABLED=false (no VITE_CLERK_PUBLISHABLE_KEY set)"
fi

# Export build args for Kamal's Docker build
# Kamal reads KAMAL_BUILD_ARGS to pass to docker build
export KAMAL_BUILD_ARGS="$BUILD_ARGS"
