version: '3.8'

services:
  # React Frontend served via nginx
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Authentication (optional) - set in .env file
        - VITE_CLERK_PUBLISHABLE_KEY=${VITE_CLERK_PUBLISHABLE_KEY:-}
        - AUTH_ENABLED=${AUTH_ENABLED:-false}
        - AUTH_ALLOW_SIGNUP=${AUTH_ALLOW_SIGNUP:-false}
    ports:
      - "3000:80"
    environment:
      # Use 'backend' as hostname for docker-compose (service name)
      - BACKEND_HOST=backend
      - BACKEND_PORT=52817
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - localmind-network
    restart: unless-stopped

  # Python FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "52817:52817"
    volumes:
      # Persist database
      - localmind-data:/app/data
      # Mount app.config.json for configuration
      - ./app.config.json:/app/app.config.json:ro
    environment:
      - PYTHONPATH=/app
      - DATABASE_PATH=/app/data/local_mind.db
    # Allow container to access host services (e.g., Ollama on host machine)
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - localmind-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:52817/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

networks:
  localmind-network:
    driver: bridge

volumes:
  localmind-data:
    driver: local
